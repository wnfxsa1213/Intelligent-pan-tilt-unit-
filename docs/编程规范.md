# 📘 STM32嵌入式C编程规范手册

**文档版本：** v1.0  
**适用项目：** 云台追踪系统 - STM32控制端  
**更新日期：** 2025年1月  
**规范等级：** 强制执行

---

## 📑 目录

1. [总则](#1-总则)
2. [命名规范](#2-命名规范)
3. [代码格式规范](#3-代码格式规范)
4. [注释规范](#4-注释规范)
5. [HAL库使用规范](#5-hal库使用规范)
6. [内存管理规范](#6-内存管理规范)
7. [中断与实时性规范](#7-中断与实时性规范)
8. [错误处理规范](#8-错误处理规范)
9. [代码审查清单](#9-代码审查清单)
10. [Git提交规范](#10-git提交规范)

---

## 1. 总则

### 1.1 设计原则

遵循以下编程原则（**按优先级排序**）：

| 原则 | 说明 | 示例 |
|------|------|------|
| **KISS** | Keep It Simple, Stupid | 简单的if-else优于复杂的状态机 |
| **YAGNI** | You Aren't Gonna Need It | 不实现未来可能用到的功能 |
| **DRY** | Don't Repeat Yourself | 重复代码提取为函数 |
| **SOLID** | 面向对象设计原则 | 单一职责、开闭原则等 |

### 1.2 代码质量标准

| 指标 | 目标值 | 检查方法 |
|------|--------|---------|
| 函数长度 | <50行 | 代码审查 |
| 圈复杂度 | <10 | 静态分析工具 |
| 注释覆盖率 | >50% | 人工检查 |
| 单元测试覆盖率 | >80% | gcov工具 |
| 编译警告 | 0个 | -Wall -Wextra |

### 1.3 强制性规则

**⚠️ 以下规则违反将不通过代码审查：**

1. ❌ **禁止使用`malloc/free`** - 嵌入式环境禁止动态内存分配
2. ❌ **禁止递归调用** - 栈空间有限
3. ❌ **禁止浮点除法在中断中** - 影响实时性
4. ❌ **禁止在中断中调用HAL延时函数** - 导致死锁
5. ❌ **禁止全局变量不加`volatile`** - 中断访问的变量必须加

---

## 2. 命名规范

### 2.1 文件命名

\`\`\`bash
# 模块文件：小写+下划线
servo.c
servo.h
jetson_comm.c
jetson_comm.h

# 禁止：驼峰命名
ServoControl.c  # ❌ 错误
\`\`\`

### 2.2 函数命名

#### 2.2.1 公共API函数

**格式：** \`模块名_动词名词()\`（大驼峰）

\`\`\`c
// ✅ 正确示例
HAL_StatusTypeDef Servo_Init(void);
HAL_StatusTypeDef Servo_SetAngle(ServoID_t id, float angle);
float Servo_GetAngle(ServoID_t id);
void CRSF_ProcessFrame(void);

// ❌ 错误示例
void servoInit(void);           // 小驼峰
void Servo_set_angle(void);     // 下划线分隔
void SetServoAngle(void);       // 缺少模块前缀
\`\`\`

#### 2.2.2 私有函数

**格式：** \`static\` + 小驼峰

\`\`\`c
// ✅ 正确示例
static uint16_t angleToCCR(float angle);
static void processRxBuffer(uint8_t *data, uint16_t len);

// ❌ 错误示例
static void AngleToCCR(float angle);  // 大驼峰
void processRxBuffer(void);           // 缺少static
\`\`\`

### 2.3 变量命名

#### 2.3.1 全局变量

**格式：** \`g_\` + 小驼峰

\`\`\`c
// ✅ 正确示例
volatile uint8_t g_uartRxBuffer[256];
uint32_t g_systemTickCount;
CRSF_Data_t g_crsfData;

// ❌ 错误示例
uint8_t uartRxBuffer[256];      // 缺少g_前缀
\`\`\`

#### 2.3.2 局部变量

**格式：** 小驼峰或下划线（统一即可）

\`\`\`c
// ✅ 推荐：下划线分隔（更易读）
uint16_t pulse_width_us = 1500;
float target_angle = 90.0f;
IMU_Data_t imu_data;

// ✅ 可选：小驼峰
uint16_t pulseWidthUs = 1500;
float targetAngle = 90.0f;
\`\`\`

#### 2.3.3 常量与宏

**格式：** 全大写 + 下划线

\`\`\`c
// ✅ 正确示例
#define SERVO_ANGLE_MAX       270.0f
#define CRSF_TIMEOUT_MS       1000
#define UART3_RX_BUFFER_SIZE  512

const float PI = 3.14159265f;
\`\`\`

### 2.4 类型命名

#### 2.4.1 结构体

**格式：** 大驼峰 + \`_t\` 后缀

\`\`\`c
// ✅ 正确示例
typedef struct {
    float x, y, z;
} Vector3_t;

typedef struct {
    uint16_t channels[16];
    uint32_t timestamp_ms;
} CRSF_Data_t;
\`\`\`

#### 2.4.2 枚举

**格式：** 类型名大驼峰+\`_t\`，枚举值全大写

\`\`\`c
// ✅ 正确示例
typedef enum {
    SERVO_PITCH = 0,
    SERVO_YAW = 1
} ServoID_t;

typedef enum {
    MODE_MANUAL = 0,
    MODE_ASSIST = 1,
    MODE_AUTO = 2
} ControlMode_t;
\`\`\`

---

## 3. 代码格式规范

### 3.1 缩进与空格

\`\`\`c
// ✅ 使用4空格缩进（禁用Tab）
void Servo_Init(void)
{
    if (condition) {
        doSomething();
        if (nested_condition) {
            doNestedTask();
        }
    }
}

// ✅ 运算符两侧加空格
uint16_t ccr = (pulse_us * 72) / 1000;
if (angle >= ANGLE_MIN && angle <= ANGLE_MAX) {
    ...
}
\`\`\`

### 3.2 大括号风格

**推荐：K&R风格（函数除外）**

\`\`\`c
// ✅ 函数：大括号单独成行
void Servo_Init(void)
{
    // 函数体
}

// ✅ 控制语句：大括号同行
if (condition) {
    doSomething();
} else {
    doOtherThing();
}

// ❌ 禁止：单行省略大括号
if (condition)
    doSomething();  // ❌ 容易出错
\`\`\`

### 3.3 单行长度

**限制：120字符**

\`\`\`c
// ✅ 长函数调用换行
HAL_StatusTypeDef status = IMU_PORT_I2C_ReadRegs(
    IMU_PORT_I2C_ADDRESS, 
    MPU6050_REG_ACCEL_XOUT_H, 
    buffer, 
    14
);
\`\`\`

---

## 4. 注释规范

### 4.1 文件头注释

**每个\`.c/.h\`文件必须包含文件头：**

\`\`\`c
/**
 ******************************************************************************
 * @file    servo.c
 * @brief   数字舵机控制驱动实现
 * @version 1.0
 * @date    2025-01-15
 * @author  STM32控制组
 ******************************************************************************
 * @attention
 *
 * 本模块实现基于TIM5的PWM舵机控制，支持270°数字舵机
 * 依赖：TIM5 PWM输出（333Hz）
 *
 ******************************************************************************
 */
\`\`\`

### 4.2 函数注释（Doxygen风格）

**公共API函数必须详细注释：**

\`\`\`c
/**
 * @brief  设置舵机到指定角度
 * @details
 *         将舵机移动到目标角度，自动进行角度限幅和PWM转换
 *
 * @param  id: 舵机ID
 *         @arg SERVO_PITCH: 俯仰舵机（TIM5_CH1）
 *         @arg SERVO_YAW: 水平舵机（TIM5_CH2）
 * @param  angle: 目标角度（单位：度）
 *         - 范围：0.0 ~ 270.0
 *
 * @retval HAL_OK: 设置成功
 * @retval HAL_ERROR: 参数错误
 *
 * @note   频繁调用可能导致舵机抖动，建议间隔>=20ms
 * @warning 舵机上电后需等待50ms再调用此函数
 */
HAL_StatusTypeDef Servo_SetAngle(ServoID_t id, float angle);
\`\`\`

### 4.3 TODO/FIXME标记

\`\`\`c
// TODO: 实现陀螺仪温度补偿算法
// FIXME: 高速旋转时姿态解算存在漂移
// HACK: 临时解决方案，等待HAL库修复I2C busy bug
// NOTE: 此处延迟不能省略，舵机需要稳定时间
// WARNING: 修改此参数会影响姿态解算精度
\`\`\`

---

## 5. HAL库使用规范

### 5.1 外设初始化顺序

**严格按照依赖关系初始化：**

\`\`\`c
int main(void)
{
    /* 1. 系统初始化 */
    HAL_Init();
    SystemClock_Config();

    /* 2. 基础外设（无依赖） */
    MX_GPIO_Init();
    MX_DMA_Init();          // DMA必须在UART之前

    /* 3. 通信外设 */
    MX_USART1_UART_Init();
    MX_USART2_UART_Init();
    MX_USART3_UART_Init();

    /* 4. 定时器 */
    MX_TIM5_Init();

    /* 5. 应用层初始化 */
    IMU_Init();
    Servo_Init();
    CRSF_Init();
    Jetson_Init();

    /* 6. 进入主循环 */
    while (1) {
        // 主循环
    }
}
\`\`\`

### 5.2 禁止直接寄存器操作

**⚠️ 强制使用HAL库API，除非性能关键路径**

\`\`\`c
// ✅ 推荐：使用HAL宏
__HAL_TIM_SET_COMPARE(&htim5, TIM_CHANNEL_1, ccr_value);

// ❌ 禁止：直接操作寄存器（除非极端情况）
TIM5->CCR1 = ccr_value;
\`\`\`

---

## 6. 内存管理规范

### 6.1 禁止动态内存

**❌ 绝对禁止：**

\`\`\`c
// ❌ 禁止malloc/free
uint8_t *buffer = (uint8_t*)malloc(256);
free(buffer);
\`\`\`

**✅ 替代方案：**

\`\`\`c
// ✅ 方案1：静态分配
static uint8_t g_rxBuffer[256];

// ✅ 方案2：栈分配（小数组）
void Function(void)
{
    uint8_t temp_buffer[16];  // <100字节可以用栈
}
\`\`\`

### 6.2 栈空间管理

**STM32F103栈大小：默认0x400 (1KB)**

\`\`\`c
// ✅ 安全：小数组
void SafeFunction(void)
{
    uint8_t buffer[64];   // 64字节，安全
}

// ⚠️ 危险：大数组
void DangerousFunction(void)
{
    uint8_t large_buffer[512];  // 512字节，可能栈溢出！
}
\`\`\`

---

## 7. 中断与实时性规范

### 7.1 中断优先级配置

\`\`\`c
/* 推荐优先级分配 */
HAL_NVIC_SetPriority(USART3_IRQn, 2, 0);         // Jetson高优先级
HAL_NVIC_SetPriority(USART2_IRQn, 3, 0);         // CRSF中优先级
HAL_NVIC_SetPriority(TIM2_IRQn, 5, 0);           // 1kHz控制循环
HAL_NVIC_SetPriority(SysTick_IRQn, 15, 0);       // 最低
\`\`\`

### 7.2 中断函数规范

\`\`\`c
// ✅ 正确的中断服务函数
void HAL_UART_RxCpltCallback(UART_HandleTypeDef *huart)
{
    if (huart->Instance == USART3) {
        // 1. 快速拷贝数据
        memcpy(g_rxBuffer, huart->pRxBuffPtr, RX_SIZE);
        
        // 2. 设置标志位
        g_dataReadyFlag = 1;
        
        // 3. 重启接收
        HAL_UART_Receive_DMA(&huart3, dma_buffer, RX_SIZE);
    }
}

// ❌ 错误示例
void HAL_UART_RxCpltCallback(UART_HandleTypeDef *huart)
{
    HAL_Delay(10);                    // ❌ 禁止延时
    printf("Data received\\n");        // ❌ 禁止printf
    float result = sin(angle);        // ❌ 禁止浮点运算
}
\`\`\`

### 7.3 临界区保护

\`\`\`c
// ✅ 使用HAL库临界区保护
void updateSharedVariable(uint32_t value)
{
    __disable_irq();  // 进入临界区
    g_sharedCounter = value;
    __enable_irq();   // 退出临界区
}

// ⚠️ volatile关键字（必须）
volatile uint32_t g_tickCounter = 0;  // 中断修改的变量必须volatile
\`\`\`

---

## 8. 错误处理规范

### 8.1 返回值检查

**⚠️ 强制：所有HAL函数返回值必须检查**

\`\`\`c
// ✅ 正确示例
HAL_StatusTypeDef status = HAL_UART_Transmit(&huart1, data, len, 1000);
if (status != HAL_OK) {
    logError("UART transmit failed: %d", status);
    return IMU_ERROR;
}

// ❌ 错误：忽略返回值
HAL_UART_Transmit(&huart1, data, len, 1000);  // ❌ 未检查
\`\`\`

### 8.2 断言机制

\`\`\`c
#ifdef USE_FULL_ASSERT
void assert_failed(uint8_t *file, uint32_t line)
{
    printf("ASSERT FAILED: %s:%lu\\n", file, line);
    while (1);
}
#endif
\`\`\`

---

## 9. 代码审查清单

### 9.1 提交前自检

- [ ] **编译无警告**：\`make 2>&1 | grep warning\`
- [ ] **格式化代码**：使用\`clang-format\`
- [ ] **删除调试代码**：移除\`printf调试\`
- [ ] **更新注释**：确保注释与代码一致
- [ ] **测试通过**：相关单元测试全部通过

### 9.2 代码审查要点

| 检查项 | 说明 |
|--------|------|
| **内存安全** | 无越界、无泄漏 |
| **空指针检查** | 所有指针使用前检查 |
| **整数溢出** | 加法前检查溢出 |
| **浮点比较** | 使用epsilon比较 |
| **魔法数字** | 全部定义为宏 |

---

## 10. Git提交规范

### 10.1 提交信息格式

**采用Conventional Commits规范：**

\`\`\`bash
<类型>(<范围>): <简短描述>
\`\`\`

**类型（type）：**

| 类型 | 说明 | 示例 |
|------|------|------|
| \`feat\` | 新功能 | \`feat(servo): 添加舵机角度限位保护\` |
| \`fix\` | Bug修复 | \`fix(crsf): 修复CRC校验错误\` |
| \`docs\` | 文档更新 | \`docs(readme): 更新编译说明\` |
| \`style\` | 格式调整 | \`style(imu): 统一变量命名风格\` |
| \`refactor\` | 重构 | \`refactor(pid): 简化PID计算逻辑\` |
| \`test\` | 测试代码 | \`test(servo): 添加角度转换单元测试\` |

**范围（scope）：**
- \`servo\` - 舵机模块
- \`imu\` - IMU模块
- \`crsf\` - CRSF协议
- \`jetson\` - Jetson通信
- \`attitude\` - 姿态融合
- \`pid\` - PID控制

**示例：**

\`\`\`bash
# ✅ 好的提交信息
git commit -m "feat(servo): 实现舵机角度到PWM转换功能

- 添加Servo_SetAngle()函数
- 实现角度限幅（0-270°）
- 添加单元测试"

# ❌ 差的提交信息
git commit -m "修改代码"
git commit -m "update"
\`\`\`

### 10.2 分支管理

\`\`\`bash
# 主分支
main          # 生产环境代码（受保护）
develop       # 开发分支

# 功能分支命名
feature/servo-control       # 新功能
bugfix/crsf-crc-error      # Bug修复
hotfix/imu-crash           # 紧急修复
\`\`\`

---

## 📋 快速检查清单

### 代码提交前（5分钟检查）

\`\`\`bash
# 1. 编译检查
make clean && make -j4
# 确认：0 errors, 0 warnings

# 2. 格式检查
grep -r "	" Core/Src/*.c  # 检查Tab字符
# 确认：无输出

# 3. 禁用检查
grep -r "malloc\\|free" Core/Src/*.c
# 确认：无输出

# 4. TODO检查
grep -r "TODO\\|FIXME" Core/Src/*.c
\`\`\`

---

**规范文档结束**
