# 🎯 基于YOLO的云台追踪系统 - STM32控制端开发文档

**文档版本：** v1.0  
**更新日期：** 2025年1月  
**项目状态：** 开发阶段  
**负责团队：** STM32控制组

---

## 📑 目录

1. [项目概述](#1-项目概述)
2. [系统架构](#2-系统架构)
3. [硬件配置规范](#3-硬件配置规范)
4. [软件模块设计](#4-软件模块设计)
5. [通信协议规范](#5-通信协议规范)
6. [开发流程与规范](#6-开发流程与规范)
7. [测试计划](#7-测试计划)
8. [附录](#8-附录)

---

## 1. 项目概述

### 1.1 项目背景

本项目开发一套基于YOLO目标检测的智能云台追踪系统，实现对目标的自动识别与跟踪。系统采用Jetson NX作为视觉处理单元，STM32F103RCT6作为运动控制单元，通过高速串口实现协同工作。

### 1.2 系统组成

\`\`\`
┌─────────────────────────────────────────────────────┐
│                    系统架构图                          │
├─────────────────────────────────────────────────────┤
│                                                     │
│  ┌──────────────┐         ┌──────────────┐        │
│  │  Jetson NX   │←─UART3─→│ STM32F103RCT6│        │
│  │  (视觉处理)   │ 921600  │  (运动控制)   │        │
│  └──────────────┘         └───────┬──────┘        │
│         ↑                         │               │
│         │                    ┌────┴────┐          │
│    摄像头输入                 │         │           │
│                         TIM5-PWM  软I2C          │
│                         333Hz     PA11/12        │
│                              │         │          │
│                         ┌────▼────┐ ┌─▼──────┐   │
│                         │ 数字舵机 │ │ MPU6050│   │
│                         │ (2个)   │ │  IMU   │   │
│                         └─────────┘ └────────┘   │
│                                                   │
│  ┌──────────────┐         ┌──────────────┐       │
│  │ CRSF接收机    │←─UART2─→│ STM32(控制)  │       │
│  │ (遥控器)      │ 420000  │   保险机制    │       │
│  └──────────────┘         └──────────────┘       │
└─────────────────────────────────────────────────────┘
\`\`\`

### 1.3 核心功能

| 功能模块 | 描述 | 优先级 |
|---------|------|--------|
| **姿态检测** | 通过MPU6050实时获取云台姿态 | P0 |
| **运动控制** | 双轴数字舵机精确控制（270°范围） | P0 |
| **视觉追踪** | 接收Jetson目标坐标并控制云台跟随 | P0 |
| **手动控制** | CRSF遥控器实时控制云台 | P1 |
| **保险机制** | 失联保护、急停功能 | P0 |
| **姿态稳定** | 卡尔曼滤波姿态融合 + PID稳定控制 | P1 |

### 1.4 技术指标

| 指标项 | 目标值 | 备注 |
|--------|--------|------|
| 舵机控制精度 | ±2° | 数字舵机规格 |
| 姿态解算精度 | ±2° | EKF融合 |
| 控制循环频率 | 1kHz | 主控制任务 |
| 端到端延迟 | <50ms | Jetson指令→舵机响应 |
| 失联检测时间 | 1秒 | CRSF超时 |
| 连续运行时间 | >24小时 | 稳定性要求 |

---

## 2. 系统架构

### 2.1 软件架构分层

\`\`\`
┌─────────────────────────────────────────────────┐
│          应用层 (Application Layer)              │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐      │
│  │状态机管理 │  │ 控制模式 │  │  安全监控 │      │
│  └──────────┘  └──────────┘  └──────────┘      │
├─────────────────────────────────────────────────┤
│          算法层 (Algorithm Layer)                │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐      │
│  │姿态融合   │  │ PID控制  │  │  轨迹规划 │      │
│  │(EKF/KF)  │  │ 双轴独立  │  │  平滑控制 │      │
│  └──────────┘  └──────────┘  └──────────┘      │
├─────────────────────────────────────────────────┤
│          中间层 (Middleware Layer)               │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐      │
│  │CRSF协议  │  │Jetson协议│  │  数据缓冲 │      │
│  └──────────┘  └──────────┘  └──────────┘      │
├─────────────────────────────────────────────────┤
│          驱动层 (Driver Layer)                   │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐      │
│  │IMU驱动   │  │舵机驱动   │  │  串口驱动 │      │
│  │(已完成✓) │  │(TIM5 PWM)│  │(UART1/2/3)│      │
│  └──────────┘  └──────────┘  └──────────┘      │
├─────────────────────────────────────────────────┤
│         硬件抽象层 (HAL/BSP Layer)                │
│  STM32 HAL Library + 自定义BSP                   │
└─────────────────────────────────────────────────┘
\`\`\`

### 2.2 数据流设计

\`\`\`
输入源                处理流程                    输出
┌─────┐              ┌─────┐                  ┌─────┐
│IMU  │─1kHz采样─→   │姿态 │─四元数/欧拉角─→  │PID  │
│6050 │              │融合 │                  │控制 │
└─────┘              └─────┘                  └──┬──┘
                                                  │
┌─────┐              ┌─────┐                     │
│CRSF │─420kbps─→    │通道 │─控制指令─→          │
│接收 │              │解析 │                     ▼
└─────┘              └─────┘              ┌──────────┐
                                          │ 模式选择  │
┌─────┐              ┌─────┐             │ 手动/辅助 │
│Jetson│─921.6k─→    │目标 │─坐标转换─→  │  /自动   │
│ NX  │              │解析 │             └─────┬────┘
└─────┘              └─────┘                   │
                                               ▼
                                        ┌──────────┐
                                        │舵机驱动   │
                                        │333Hz PWM │
                                        └──────────┘
\`\`\`

---

## 3. 硬件配置规范

### 3.1 MCU核心参数

| 参数 | 配置值 |
|------|--------|
| **MCU型号** | STM32F103RCT6 |
| **系统时钟** | 72MHz (HSE 8MHz × PLL 9) |
| **Flash** | 256KB |
| **SRAM** | 48KB |
| **封装** | LQFP64 |

### 3.2 引脚分配表

#### 3.2.1 IMU传感器（软I2C）

| 功能 | 引脚 | 配置 | 说明 |
|------|------|------|------|
| **SCL** | PA12 | GPIO_Output (OD) + PullUp | 时钟线 |
| **SDA** | PA11 | GPIO_Output (OD) + PullUp | 数据线 |
| **I2C地址** | 0x68 | - | AD0接地 |
| **速率** | ~100kHz | 软件延迟控制 | 标准模式 |

**注意事项：**
- 必须配置为开漏输出模式
- 外部需接4.7kΩ上拉电阻到3.3V
- 速度设置为GPIO_SPEED_FREQ_HIGH

#### 3.2.2 舵机控制（TIM5 PWM）

| 舵机 | 引脚 | 定时器通道 | 功能 | 角度范围 |
|------|------|-----------|------|---------|
| **俯仰** | PA0 | TIM5_CH1 | PWM输出 | 0-270° |
| **水平** | PA1 | TIM5_CH2 | PWM输出 | 0-270° |

**PWM参数：**
\`\`\`c
频率计算：72MHz / (Prescaler × Period)
       = 72MHz / (72 × 3003) = 333.0Hz ✓

脉宽范围：500-2500μs (对应0-270°)
中位脉宽：1500μs (对应135°)
\`\`\`

#### 3.2.3 串口配置

| 串口 | 引脚 | 波特率 | 用途 | DMA |
|------|------|--------|------|-----|
| **USART1** | PA9(TX), PA10(RX) | 115200 | 调试输出 | 否 |
| **USART2** | PA2(TX), PA3(RX) | **420000** | CRSF接收机 | 建议启用 |
| **USART3** | PB10(TX), PB11(RX) | **921600** | Jetson通信 | 必须启用 |

**USART3 DMA配置：**
- DMA1_Channel2: USART3_TX (高优先级)
- DMA1_Channel3: USART3_RX (高优先级)

#### 3.2.4 其他引脚

| 功能 | 引脚 | 配置 | 说明 |
|------|------|------|------|
| **激光指示** | PA7 | GPIO_Output | 目标指示灯 |
| **SWD调试** | PA13(SWDIO), PA14(SWCLK) | - | ST-Link连接 |

### 3.3 外设时钟配置

\`\`\`c
系统时钟树：
HSE (8MHz) → PLL × 9 → SYSCLK (72MHz)
                     ↓
            AHB (HCLK) = 72MHz
            ├── APB1 (PCLK1) = 36MHz  // USART2/3, TIM5
            │   └── TIM5时钟 = 72MHz (APB1 × 2)
            └── APB2 (PCLK2) = 72MHz  // USART1, GPIOA/B
\`\`\`

---

## 4. 软件模块设计

### 4.1 模块清单

| 模块名 | 文件 | 状态 | 依赖 | 优先级 |
|--------|------|------|------|--------|
| IMU驱动 | `imu.c/h`, `soft_i2c.c/h` | ✅ 已完成 | HAL | P0 |
| 舵机控制 | `servo.c/h` | ⏳ 待开发 | TIM5 HAL | P0 |
| CRSF协议 | `crsf.c/h` | ⏳ 待开发 | USART2 HAL | P1 |
| Jetson通信 | `jetson_comm.c/h` | ⏳ 待开发 | USART3 DMA | P0 |
| 姿态融合 | `attitude.c/h` | ⏳ 待开发 | IMU, 数学库 | P1 |
| PID控制 | `pid.c/h` | ⏳ 待开发 | 无 | P1 |
| 状态机 | `state_machine.c/h` | ⏳ 待开发 | 所有模块 | P2 |

---

## 5. 通信协议规范

### 5.1 Jetson ↔ STM32 通信协议

#### 5.1.1 数据帧格式（草稿，待Jetson组确认）

\`\`\`
┌────────┬────────┬─────────┬──────────┬──────┬────────┐
│ Header │ Length │ MsgType │ Payload  │ CRC8 │ Footer │
├────────┼────────┼─────────┼──────────┼──────┼────────┤
│  0xAA  │  1B    │   1B    │  N Bytes │  1B  │  0x55  │
└────────┴────────┴─────────┴──────────┴──────┴────────┘
\`\`\`

#### 5.1.2 CRSF协议规范

- **波特率：** 420000
- **帧格式：** 地址(1B) + 长度(1B) + 类型(1B) + 数据(NB) + CRC8(1B)
- **通道数：** 16通道，每通道11位（范围172-1811）
- **失联检测：** 1秒无数据触发保险机制

---

## 6. 开发流程与规范

### 6.1 四阶段开发计划

#### 阶段一：硬件验证与基础驱动（1-2周）

**任务：**
1. 修正CubeMX配置（USART2/3波特率）
2. 开发舵机驱动（servo.c/h）
3. 优化IMU 1kHz采样
4. 完善串口调试工具

**验收标准：**
- ✅ 舵机控制精度±2°
- ✅ IMU数据稳定输出

#### 阶段二：通信协议实现（2-3周）

**任务：**
1. CRSF接收机驱动
2. Jetson通信基础（预留CRC8接口）
3. 保险机制实现

**验收标准：**
- ✅ CRSF数据稳定解析（>100Hz）
- ✅ 失联保护1秒触发

#### 阶段三：姿态融合与控制算法（3-4周）

**任务：**
1. EKF姿态融合集成
2. PID控制器实现
3. 三种控制模式（手动/辅助/自动）

**验收标准：**
- ✅ 姿态精度<2°
- ✅ PID响应<200ms，超调<10%

#### 阶段四：系统集成与优化（2周）

**任务：**
1. 状态机整合
2. Jetson CRC8集成
3. 性能优化（1kHz控制循环）
4. 24小时稳定性测试

**验收标准：**
- ✅ 端到端延迟<50ms
- ✅ 连续运行24小时无崩溃

---

## 7. 测试计划

### 7.1 单元测试

| 模块 | 测试项 | 预期结果 |
|------|--------|---------|
| Servo | 角度精度 | 误差<±2° |
| IMU | 数据稳定性 | σ<0.1g |
| CRSF | 帧解析准确率 | >99.9% |
| PID | 阶跃响应 | 超调<10%, 稳定<200ms |

### 7.2 集成测试

#### 测试用例1：手动控制模式
\`\`\`
前置条件：CRSF接收机正常连接
步骤：
1. 开机，等待初始化完成
2. 拨动遥控器摇杆
3. 观察云台响应

验收：
- 云台跟随摇杆平滑移动
- 无抖动或延迟>50ms
\`\`\`

#### 测试用例2：失联保护
\`\`\`
前置条件：CRSF接收机正常连接
步骤：
1. 正常控制云台
2. 关闭遥控器
3. 观察云台行为

验收：
- 1秒后舵机回到中位
- 串口输出失联告警
\`\`\`

---

## 8. 附录

### 8.1 常用调试命令

\`\`\`bash
# 编译项目
make -j4

# 烧录固件
openocd -f interface/stlink.cfg -f target/stm32f1x.cfg \\
        -c "program build/IMU.elf verify reset exit"

# 串口监控
minicom -D /dev/ttyUSB0 -b 115200
\`\`\`

### 8.2 故障排查清单

| 问题 | 可能原因 | 解决方法 |
|------|---------|---------|
| IMU初始化失败 | I2C连接问题 | 检查PA11/PA12连接 |
| 舵机无响应 | PWM未启动 | 确认HAL_TIM_PWM_Start已调用 |
| CRSF无数据 | 波特率错误 | 验证USART2配置为420000 |
| Jetson通信丢包 | DMA缓冲区溢出 | 增大缓冲区或降低发送频率 |

### 8.3 参考资料

- [STM32F1xx HAL库文档](https://www.st.com/resource/en/user_manual/um1850.pdf)
- [CRSF协议规范](https://github.com/crsf-wg/crsf/wiki)
- [MPU6050数据手册](https://invensense.tdk.com/products/motion-tracking/6-axis/mpu-6050/)
- [Madgwick姿态融合算法](https://x-io.co.uk/open-source-imu-and-ahrs-algorithms/)

### 8.4 项目目录结构

\`\`\`
IMU/
├── Core/
│   ├── Inc/
│   │   ├── imu.h              ✅ 已完成
│   │   ├── servo.h            ⏳ 阶段一
│   │   ├── crsf.h             ⏳ 阶段二
│   │   ├── jetson_comm.h      ⏳ 阶段二
│   │   ├── attitude.h         ⏳ 阶段三
│   │   └── pid.h              ⏳ 阶段三
│   └── Src/
│       └── (对应.c文件)
├── Drivers/                   # STM32 HAL库
├── Makefile
├── IMU.ioc                    # CubeMX配置文件
└── docs/
    ├── 开发文档.md             # 本文档
    ├── 编程规范.md
    └── API文档/
\`\`\`

---

## 📋 开发检查清单

### 阶段一：硬件验证
- [ ] CubeMX配置修改完成
- [ ] 舵机驱动代码编写完成
- [ ] 舵机测试通过（±2°精度）
- [ ] IMU 1kHz采样实现
- [ ] printf重定向调试工具可用

### 阶段二：通信协议
- [ ] CRSF帧解析实现
- [ ] CRSF失联检测工作正常
- [ ] Jetson通信框架完成
- [ ] DMA接收缓冲区实现
- [ ] 心跳包机制验证

### 阶段三：算法实现
- [ ] EKF姿态融合集成
- [ ] 姿态精度测试通过
- [ ] PID控制器实现
- [ ] 三种控制模式实现
- [ ] 模式切换平滑

### 阶段四：系统集成
- [ ] 状态机实现
- [ ] Jetson CRC8集成
- [ ] 端到端延迟<50ms
- [ ] 24小时稳定性测试通过
- [ ] 文档完成

---
       

**文档结束**
